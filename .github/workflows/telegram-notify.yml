name: Notify Telegram on Commit

on:
  push:
    branches:
      - master

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get commit details
        id: commit_details
        run: |
          # Extract the number of files changed, insertions, and deletions
          FILES_CHANGED=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | wc -l)
          INSERTIONS=$(git diff --stat ${{ github.event.before }}..${{ github.sha }} | tail -1 | grep -oP '\d+(?= insertions)')
          DELETIONS=$(git diff --stat ${{ github.event.before }}..${{ github.sha }} | tail -1 | grep -oP '\d+(?= deletions)')
          
          # Store in environment variables
          echo "FILES_CHANGED=${FILES_CHANGED}" >> $GITHUB_ENV
          echo "INSERTIONS=${INSERTIONS}" >> $GITHUB_ENV
          echo "DELETIONS=${DELETIONS}" >> $GITHUB_ENV

      - name: Format commit time in GMT+5
        id: format_time
        run: |
          # Convert the commit time to GMT+5
          COMMIT_TIME=$(date -d "${{ github.event.head_commit.timestamp }}" +"%Y-%m-%d %H:%M:%S" --utc | awk '{print strftime("%Y-%m-%d %H:%M:%S", systime() + 18000)}')
          echo "COMMIT_TIME=${COMMIT_TIME}" >> $GITHUB_ENV

      - name: Send notification to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GITHUB_COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_TIME: ${{ env.COMMIT_TIME }}
          FILES_CHANGED: ${{ env.FILES_CHANGED }}
          INSERTIONS: ${{ env.INSERTIONS }}
          DELETIONS: ${{ env.DELETIONS }}
        run: |
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage -d chat_id=${TELEGRAM_CHAT_ID} -d parse_mode=Markdown -d text="
          *New commit in the repository:* '${GITHUB_REPOSITORY}' 

          üë®‚Äçüíª *Author:* ${GITHUB_COMMIT_AUTHOR}
          
          üìú *Message:* '${GITHUB_COMMIT_MESSAGE}'
          
          üïí *Commit Time (GMT+5):* ${COMMIT_TIME}
          
          üìù *Files Changed:* ${FILES_CHANGED}
          ‚ûï *Insertions:* ${INSERTIONS}
          ‚ûñ *Deletions:* ${DELETIONS}
          
          Great job, team!
          "
